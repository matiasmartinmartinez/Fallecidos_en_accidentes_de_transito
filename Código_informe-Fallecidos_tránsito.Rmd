---
title: " Siniestros de tránsito fatales en Uruguay, 2013-2017 "
author: "Martínez Matías, Zang Bruno"
date: "12 de junio de 2018"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = 'hbpt', out.extra = '', message = FALSE, warning = FALSE)
```


## Introducción

El presente estudio surge de la curiosidad por conocer el comportamiento de los siniestros de tránsitos en Uruguay y posee como objetivo madre una profunda aplicación de los conocimientos adquiridos en la asignatura "Nuevas técnicas para el análisis de datos", marcando énfasis en un correcto análisis exploratorio y la generación de adecuadas visualizaciones de los datos.
Se analizara tanto los datos del fallecido como lo del suceso.


### Antecedentes:

En su programa de Sistema de Información Nacional de Tránsito (SINATRÁN), donde se extrajo los datos, la Unidad Nacional de Seguridad Vial (UNASEV), genera un informe anual sobre la Siniestralidad Vial en Uruguay para el periodo dado desde 2009 a la actualidad.
Dicho informes se pueden encontrar a través del siguiente enlace:http://unasev.gub.uy/inicio/sinatran/informes_siniestralidad_vial_uruguay/


## Datos obtenidos

Los datos fueron obtenidos de la Unidad Nacional de Seguridad Víal (UNASEV), correspondientes al período comprendido entre 2013 y 2017. Originalmennte los datos correspondían al año 2017, sin embargo se identificó apropiada la utilización de una serie de tiempo por lo cual se mecharon bases desde el año 2013, esto provocó ciertos inconvenientes en cuanto a nombres de variables debido a la utilizacion de tildes o el aumento de variables para ciertos años pero finalmente fueron solucionados y concluimos en una base de datos apta y abarcativa.

Mediante su catálogo de datos abiertos se extraen las bases utilizadas, desde el siguiente url: http://unasev.gub.uy/inicio/sinatran/datos_abiertos/


### Población:

Corresponde a los 2527 fallecidos en accidentes de tránsito dentro del territorio uruguayo para el período antes señalado.

### Descripción de las variables:

Se poseen 15 variables identificadas de la siguiente manera:

- **a:** Año. 
- **fecha:** Dia y Mes. 
- **hora:** Hora.
- **dep:** Departamento.
- **jur:** Jurisdicción.
- **tipo.sin:** Tipo de Siniestro.
- **vehi:** Vehiculo.
- **rol:** Rol que cumplía.
- **edad:** Edad al fallecer.
- **Sexo:** Sexo de la persona.
- **f.dias:** Dia de supervivencia.
- **otro.vehi:** Otro vehiculo involucrado.
- **dir:** Lugar del accidente.
- **x:** Latitud.
- **y:** Longitud.


## Modelos y herramientas

Es importarte recordar los objetivos del estudio, uno de ellos guía a la implementación de apropiadas visualizaciones. Para esto se utilizará el software estadístico R, con la puntual aplicación de paquete "tidyverse", que proporciona un conjunto de librerías óptimas para el análisis exploratorio de datos.
Con el fin de crear visualizaciónes oportunas se gestará su formación con la librería "ggplot2", perteneciente a tidyverse, la cual al trabajar mediante acumulación de capas (layers) posee una mayor flexibilidad y permite generar gráficos que representen correctamente los datos, sin generar interpretaciones confusas. Toma como referencia una metodología de visualización de datos llamada the Grammar of Graphics (Wilkinson, 2005), que consiste en especificar de manera independiente las componentes del gráfico como si fuesen bloques y luego combinarlas.


## Preguntas a responder

 - ¿Cuál es la distribución relativa por sexo y qué comportamiento posee la edad del fallecido en el período dado?

 - ¿Cuál es la densidad de fallecidos por departamento?
 
 - ¿Existe relación entre el vehículo del fallecido y su rol en el mismo?
 
 - ¿Cuál es la frecuencia relativa según el tipo de siniestro para cada año?
 
 - ¿Qué comportamiento posee la jurisdicción por si misma, y según el tipo de siniestro ocurrido?
 
 - ¿Hay relación entre el vehículo del fallecido y otro posible vehículo involucrado en el accidente?
 
 - ¿Cuál es la media de días de supervivencia luego del accidente?
 
 - ¿Qué fechas y horarios poseen mayor frecuencia acumulada de fallecidos?


## Hipótesis

- Se considera que el comportamiento de la edad estará dado por una fuerte densidad para edades cercanas a los 25, ya que se acompaña de poca experiencia al volante y pocas responsabilidades en comparación a mayores edades. Por ende, con respecto a la variable sexo, se preevé una mayor proporción de difuntos para las personas de sexo masculino.

- Debido a la concentración en zonas metropolitanas tanto en sectores productores, educativos, turísticos, ect; se provocán altos porcentajes de accidentes de tráficos y esto tendra como consecuencias que dichos departamentos indiquen las mayores proporciones de fallecidos en el país. 

- Por cuestiones de seguridad es de esperar frecuencias absolutas mayores para vehículos más débiles en su ensamblaje como motos, bicicletas, autos pequeños, etc. Dicho esto, se considera mayor mortalidad para conductores de los mismos y para los consiguentes vehículos la mortalidad estará dada principalmente en pasajeros, ya que su estructura protege mayormente al conductor.

- Los tipos de siniestros que mayoritariamente se llevan vidas serán colisión entre vehículos e impacto con obstáculos. Esta hipótesis surge en la brusquedad identificada para dichos accidentes.

- Se prevé mayor proporción de accidentes fatales en rutas nacionales, esto en base principalmente a la práctica de altas velocidades. Tanto despistes como colisiones tendrán mayor propoción de fallecidos en rutas no departamentales, sin embargo he de excluirse atropello de peatones de dicha jurisdicción debido a su nula circulación en las mismas.

- Colisiones entre un vehiculo de gran magnitud y otro de menor provocaría que el de menor quede expuesto a graves consecuencias, esto genera la hipotesis de una fuerte relacion en fallecimientos en vehiculos como: motos, bicicletas, inclusive peatones, ect; al impactar con autos, camionetas, ómnibus,camiones,ect.

- Consiguiente a anteriores menciones, tales impactos generían una muerte instantánea o de poca supervivencia para el individuo. Si valoramos posibles traslados desde carretera o largas distancias a un centro de atención médica de calidad (los cuales en mayor grado se encuentran en la capital nacional) las probabilidades de salir con vida de dicho accidente se reducen drasticamente.

- En meses de vacaciones se provocarían mayores accidentes de tráfico producto de congregaciones y movimientos en general. Respecto al día y hora se considera altas frecuencias absolutas para fines de semana en horarios nocturnos.


## 

```{r,echo=F,warning=FALSE,error=FALSE}


#Función que instala y carga los paquetes a utilizar
ipack <- function( pkg )
  {
  
  new.pkg <-  pkg[ ! (pkg %in% installed.packages()[, "Package"]) ]
      if ( length(new.pkg) ) 
        install.packages(
          new.pkg, dependencies = TRUE )
    sapply( pkg, require, character.only = TRUE )
    
    }

paquetes.a.utilizar<- c("tidyverse", "ggmosaic", "plotly", "ggmap", "raster", "rgdal","knitr","scales","lubridate")

ipack(paquetes.a.utilizar)


load("base_datos___fallecidos_transito_uruguay_2013-2017.RData")

colores<-c("darkolivegreen3","turquoise4","tan2","indianred",
           "khaki3", "thistle4", "lightsteelblue","grey80")
```

## Análisis Exploratorio de Datos


```{r}

dim(datos)
str(datos)

```


### Fallecidos por año

```{r,warning=FALSE,echo=F,fig.cap="Gráfico de series de tiempo: frecuencia absoluta de fallecidos por año."}

ggplotly(
   datos %>% dplyr::count(a)  %>% 
     ggplot(   aes(a, n)) + 
     geom_point() + geom_line()+
     theme_minimal()+
     labs(
       x = "Año", 
       y = " Frecuencia relativa de fallecidos") +
     theme(plot.title = element_text(
       size =16, 
       colour = "grey16"))+ 
     coord_cartesian(ylim=c(0,600)) ) 


```

Desde el año 2013 la frecuencia absoluta de fallecidos en tránsito manifestaba un claro descenso. Ésta racha se detuvo en el año 2017 donde sucedieron 24 muertes más que en el año previo. Pese a esto, tal pendiente en la cantidad de fallecidos profiere un correcto desarrollo y accionar en sectores políticos y una alta concientización en los uruguayos para dichos temas.


### Sexo

```{r,echo=F,fig.cap="Gráfico de serie de tiempo: frecuencia absoluta de fallecidos por sexo medido en años."}

ggplotly(
   datos %>% dplyr::count(a, sexo) %>% 
     ggplot(
       aes(
         a,
         n,
         colour=sexo)) +
     geom_point()+
     geom_line(cex=1) +
     theme_minimal() +
     labs(
       x = "Año", 
       y = "Frecuencia absoluta de fallecidos") + 
     guides(colour=guide_legend(title="Sexo:")) +
     theme(
       plot.title = element_text(
         size = 14.4,
         colour = "darkslategrey")) +
     coord_cartesian(ylim = c(0,500)) +
     scale_color_manual( values=colores)  )



```

 Para el sexo masculino se puede ver un decenso significativo de fallecidos para este período trabajado. En cambio, el sexo femenino percibe una continiudad en la frecuencia absoluta que no varía significativamente en los tiempos transcurridos.


### Edad

```{r,echo=F,fig.cap="Gráfico de densidad: distribución en la edad del fallecido según año."}



datos %>% ggplot(aes(edad)) + 
  geom_density(
    aes(fill=a),
    size=0.74,
    colour="grey10",
    show.legend = F) + 
  labs(
    x="Edad del fallecido",
    y="Densidad") +
  theme(
    axis.title = element_text(
      size=11.5,
      colour="grey20"),
    panel.background = element_rect(
      fill="gray96"))+
   facet_wrap(~a)

```

 Se percibe una fuerte concentración en edades cercanas a los 25 años, la cual es inalterable al paso de los años para el período dado. Sin embargo, la distribución para aproximadamente de 30 a 70 años varía cosiderablemente: de poseer una meseta en el 2013, luego poseer una brusca y cosiderable pendiente decreciente en el año 2014, a retomar lentamente su meseta pero más expandida, llegando a los 70 años con proporciones superiores al 10%.
 
 
```{r,fig.cap="Diagrama de caja: edad del fallecido según sexo."}


ggplotly(
  datos %>% 
    ggplot(    aes( sexo, edad, fill=sexo )   ) + 
    geom_boxplot(
      alpha=0.4,
      show.legend = F) + 
    labs(
      x =  "Sexo",
      y = "Edad en años") + 
    theme_bw()+
    theme(axis.title = 
            element_text(
              size = 12.6,
              colour = "grey27")) +
    scale_fill_manual(values=colores) ) 



```
 
  Para el sexo femenino existe una amplia variación de los datos, ya que pese a corresponder a aproximadamente un 25% de los fallecidos logra poseer un rango intercuartílico mayor al masculino. Los hombres en tanto se concentran a edades menores, con una mediana 6 años menor que la femínea.
  
  
### Rol

```{r,fig.cap="Gráfico de densidad: distribución de la edad del fallecido según rol del mismo."}

datos %>% ggplot(aes(edad)) +
  geom_density(
    aes(fill = rol), 
    alpha = 0.4, 
    show.legend = T) +
  labs(
    x =  "Edad", 
    y = "Densidad")  + 
  theme_minimal() + 
  guides(fill = guide_legend(title = "Rol:")) +
  theme(
    legend.position = "bottom", 
    plot.title = (element_text(
      size = 16,
      hjust = 0.33,
      colour = "darkslategray")))+ 
  scale_fill_manual(values = colores[(c(4,1,2))]) 


```

 La distribución de la densidad en la edad según el rol del fallecido cambia suntuosamente dependiendo si existe la condición de peatón o no: en el caso de existir se observa una fuerte concentración a edades avanzadas, sin embargo en el caso de no serlo su concentración es mayoritariamente en adultos menores (de 20 a 30 años).
 Los conductores por su parte predominan sobre los pasajeros desde los 17 a los 72 años, fuera de este período la densidad de pasajeros crece debido a que a ciertas edades la persona no está apta para conducir o simplemente decide no hacerlo.


```{r,fig.cap="Gráfico de series de tiempo: frecuencia absoluta de fallecidos según rol para el período dado."}

ggplotly(
  datos %>% dplyr::count(rol, a) %>% group_by(a) %>%
     ggplot(
         aes(a,n,
             colour=rol)) + 
     geom_line(cex=1)  + 
     geom_point(cex=1.2) +
     theme_minimal()  +
     labs(
         x="Año",
         y="Frecuencia absoluta de fallecidos") + 
     theme_minimal() +
    guides(colour= guide_legend(title="Rol:"))+
     coord_cartesian(y=c(0,400))+ 
       theme(
         axis.title = element_text(
           colour="grey30")) +
       scale_colour_manual(values =  colores[(c(4,1,2))]) 
     )
```

Para este período trabajado no parece variar significativamente las frecuencias absolutas de los peatones y pasajeros. La misma tiende a mantenerse en el tiempo con aproximadamente 80 casos al año en ambos, mientras que en fallecidos en rol de conductores denotan un ligero descenso hasta el año 2016.


### Peatones

```{r}

```




### Vehículo

```{r,echo=F,fig.cap="Gráfico de series de tiempo: frecuencia absoluta de difuntos por vehículo para cada año."}

ggplotly(
datos %>% dplyr::count(vehi,a) %>% 
  mutate(vehi=ifelse(n<=50,"OTROS",vehi)) %>%
  group_by(vehi,a) %>% summarise(n=sum(n))%>%
   ggplot(
     aes(
       a,
       n,
       colour=vehi)) + 
   geom_line(
     stat ="identity",
     show.legend = T,
     cex=1.1 ) +
  geom_point()+
   labs(
     x = "Año",
     y = "Frecuencia absoluta de fallecidos") +
   theme_minimal()+ guides(colour=guide_legend(title="Vehículo:"))+
   theme(axis.title = element_text(
       colour = "grey30"))+
   scale_colour_manual(
     values = colores) +
  coord_cartesian(ylim=c(0,310)))

```

Existe un claro decenso de las motos como vehículo del fallecido y se puede visualizar una clara continuidad en la frecuencia absoluta para los auto, peaton y otros; cabe resaltar que  autos y motos precentaban un decenso a exepcion del año 2017 donde ocurrio un aumento de fallecidos.


```{r,fig.cap=" Gráfico de densidad: distribución de la edad de fallecidos en auto o moto."}

datos %>% filter(vehi== "AUTO" | vehi=="MOTO")%>% 
  ggplot(aes(edad)) +
   geom_density(
     aes(fill = vehi), 
     alpha = 0.5, 
     show.legend = T) +
   labs(
     x =  "Edad", 
     y = "Densidad")  + 
   theme_minimal() + 
   guides(fill = guide_legend(title = "Vehículo:")) +
   theme(
     legend.position = "bottom", 
     axis.title  = (element_text(
       size = 12,
       colour = "darkslategray"))) + 
  scale_fill_manual (values=colores[c(3,2)])

```

Se denota que próximos a adultos menores exite un notable crecimiento de fallecidos para las motos, alcanzando su tope a la edad cercana de 25 años para luego presentar un paulatino decenso.
En tanto autos representan una distribución aproximadamente constante desde los 25 a los 70 años. Para edades cercanas a 50 años los fallecidos en dicho vehículo comienzan a tener mayores proporciones en contraste con motos.


### Relación vehículo

```{r,echo=F,warning=FALSE,fig.cap="Gráfico de mosaico: proporción de fallecidos en cada rol según vehículo."}



ggplotly(
 datos  %>%  dplyr::count(vehi, rol) %>% filter(vehi!="PEATON")  %>%
    group_by( vehi= ifelse ( 
      (vehi!="BICICLETA" & vehi!="MOTO" & vehi!="AUTO" & vehi!="BICICLETA" & 
         vehi!="CAMIONETA"),"OTROS", vehi ),rol)  %>%
    summarise(n=sum(n))  %>%
    ggplot()  +
    geom_mosaic(aes(
      weight = n,
      x = product(  reorder(abbreviate(vehi, 4),-n)  ),
      fill = abbreviate( rol, 1) ),
      alpha=0.64)  +
    labs(
      x = "Vehículo del fallecido",
      y = "Proporción de fallecidos") +
      guides(fill = guide_legend(title = "Rol")) +
      theme_minimal() +
      theme(
      axis.title =
        element_text(
          size = 12,colour="grey30")) +
      scale_fill_manual(  values = colores[c(2,3,1)]))

```
Se filtraron los datos de manera tal que se removieron las observaciones correspondientes con vehiculos igual a "PEATON", considerando que las mismas poseen como rol el de peaton y esto no aportaba mayor información al gráfico.
Además con la finalidad de una mejor visualización designamos una nueva categoría llamada "OTROS" en los cuales colocamos los niveles de vehículos con pocas obvservaciones.

Es de destacar que quienes sufren la mayor proporción de muertes por accidentes de tránsito son los conductores, principalmente quienes conducen autos y motos, siendo estos últimos los poseedores de la mayor probabilidad de fallecer siendo conductores.

```{r,fig.cap="Gráfico de mosaico: proporción de otro posible vehículo involucrado según el vehículo del fallecido."}

ggplotly(
  datos %>% dplyr::count(vehi, otro.vehi)  %>%
   mutate(otro.vehi = ifelse( otro.vehi == ""," NADA",otro.vehi), 
          vehi = ifelse(vehi!="AUTO" & vehi!="MOTO" & vehi!="PEATON" & vehi!="BICICLETA"  & vehi!="CAMIONETA","OTROS",vehi),
          otro.vehi = ifelse(n<30,"OTROS",otro.vehi)) %>% 
    group_by(vehi,otro.vehi)%>% 
    summarise(n=sum(n)) %>% arrange(desc(n)) %>%
    ggplot() + 
    geom_mosaic(aes( 
      weight = n,
      x = product(abbreviate(vehi,5)),
      fill = otro.vehi)) +
    labs(
      x = "Vehículo del fallecido",
      y = "Proporción de otro vehículo") +
    guides(  fill = guide_legend( title = "Otro vehículo")) +
    scale_fill_manual(
      values = c("darkseagreen4",colores[3:8])) +
    theme( 
      panel.background = element_rect(
        fill="white"),
      axis.title  = element_text(
        colour = "gray37")) )

```

Únicamente incluye las relaciones con frecuencia absoluta mayores o iguales a 30 fallecidos.

La mayor proporción de los accidentes desde el punto de vista del fallecido no involucran otro vehículo. El medio de transporte que más involcrado estuvo en los accidentes fue el auto. 
Es de apreciar que la distribución varía considerablemente dependiendo del vehículo en cuestión.


### Jurisdicción

```{r,echo=F, fig.cap="Gráfica de serie de tiempo: frecuencia absoluta de fallecidos por jurisdicción."}

ggplotly(
datos %>% dplyr::count(jur, a) %>%group_by(a) %>% mutate(prop = n / sum(n))  %>%
  ggplot(
    aes(
      x=a,
      y=n,
      colour=jur)) +
  geom_point() +
  geom_line(cex=1.1) +
  labs(
    x = "Jurisdicción",
    y = "Frecuencia absoluta") + 
  guides(colour = guide_legend(title = "Jurisdicción:"))+
  scale_colour_manual( values = colores) +
  theme(
    panel.background = element_rect(fill="white"),
    axis.title  = element_text(
      colour = "gray29"),
    legend.position = "bottom") + 
  coord_cartesian(y=c(0,400))
)
 
```

Existe una disminución de la proporción de fallecimientos en jurisdicciones nacionales hasta el año 2015 y luego se comporta con una pendiete creciente hasta el final del período dado, donde supera a los fallecidos en departamentales en el año 2017.


```{r,fig.cap="Gráfico de mosaico: proporción en la existencia o no de otro vehículo involucrado según la jurisdicción en la que ocurrió el accidente."}

datos %>% dplyr::count(involucrado, jur) %>%
  ggplot() +
  geom_mosaic(aes(
    weight = n,
    x = product(jur),
    fill = involucrado),
    alpha=0.5) +
  labs(
    x = "Jurisdicción",
    y = "Proporción involucrado") +
  theme(
    panel.background = element_rect(
      fill="white"),
    plot.title = element_text(
      size = 16,
      face = "italic",
      colour = "grey20",
      vjust = -2),
    axis.title = element_text(
      size=12,
      colour="grey20")) + 
  scale_fill_manual(
    values = colores) +
  guides(
    fill= guide_legend("Involucrado"))

```

Si bien para ambas jurisdicciones existe una alta proporción de accidentes fatales con otro vehículo involucrado (aproximadamente un 60%), sobresale en departamental acercándose a un 75% de los accidentes fatales.


```{r,fig.cap="Gráfico de mosaicos: jurisdicción del accidente de tránsito según tipo de siniestro."}
 

datos %>% dplyr::count(tipo.sin, jur) %>%
  mutate(tipo.sin=ifelse(n <= 60,"OTROS",tipo.sin) ) %>% 
  ggplot() +
  geom_mosaic(
    aes(
      weight = n,
      x = product( abbreviate(tipo.sin, 5) ),
      fill = jur),
    alpha=0.5) +
  theme(
      legend.position = "bottom",
      panel.background = element_rect(
        fill="white"),
          axis.title =
      element_text(
        colour="grey24")) + 
  labs(
    x = "Tipo de siniestro",
    y = "Proporción jurisdicción",
    fill = "Jurisdicción") + 
  scale_fill_manual(
    values =  colores ) 


```

Salvo despistes y atropellos de animales, los restantes tipos de siniestros predominan en jurisdicciones departamentales. El tipo de accidente con mayor proporción de difuntos es la colisión entre vehículos, acompañada de los despiestes y atropellos de peatones respectivamente.


### Días de supervivencia

```{r,fig.cap="Gráfico de barras y Pareto: proporción de fallecidos según los días de supervivencia luego del accidente, acompañado de la frecuencia relativa acumulada para los mismos."}


ggplotly( 
  ggplot() +   
    geom_bar(
      data= (datos %>% dplyr::count(f.dias) %>% mutate(n = n / sum(n))) ,
      aes(f.dias, n), 
      stat ="identity") +
    stat_ecdf(
      data=datos,
      aes(f.dias),
      cex=1.09,
      geom = "line",
      colour=colores[2]) +
   labs(
     x = "Días de supervivencia luego del accidente" ,
     y = "Proporción de fallecidos") + 
   theme_get()+
   theme(
     plot.title = element_text(
     hjust = 0.4,
     size = 16,
     colour = "gray27"),
    axis.title = element_text(
      size=11.6,
      colour="grey20")))

```

La curva azul corresponde al diagrama de Pareto y representa la frecuencia relativa acumulada hasta *x* día.

Existe una probabilidad cercana a un 60% de fallecer en el instante o no superar las 24 horas.


```{r,fig.cap="Gráfico de barras: proporción de fallecidos en muerte súbita según tipo de siniestro."}



datos %>% filter(f.dias == 0) %>% dplyr::count(tipo.sin) %>%
  mutate(n = n / sum(n)) %>%  ggplot() +
  geom_bar(
  aes(reorder(abbreviate(tipo.sin, 6),-n), n),
  stat = "identity",
  show.legend = F) + theme_minimal() +
  labs(
    x = "Tipo de Siniestro" ,
    y = "Proporción de fallecidos") +
  theme(
    axis.title = element_text(
      size=13,
      colour="grey26")  )
```

Muerte súbita hace alución a la persona que falleció en el acto o en menos de 24 horas luego de ocurrido el accidente.

De igual manera que para el total, colisiones entre vehiculos, despistes y atropello de peaton son los tres tipos de siniestros que mayor proporción de fallecios en muerte súbita poseen.


### Departamento



```{r,warning=FALSE,echo=FALSE}

uruguay <- getData("GADM", country = "UY", level = 0)
uruguay_states <- getData("GADM", country = "UY", level = 1)
uystates_UTM <-spTransform(uruguay_states, CRS("+init=EPSG:5383"))
NAME_1 <- uystates_UTM@data$NAME_1


# Función mapa
mapeo<-  function(n) 
  {
  
  df <- data.frame(NAME_1,n)
  uystates_UTM@data$id <- rownames(uystates_UTM@data)
  uystates_UTM@data <- plyr::join(uystates_UTM@data, df, by="NAME_1")
  uystates_df <- fortify(uystates_UTM)
  uystates_df <- plyr::join(uystates_df,uystates_UTM@data, by="id")
  uystates_df <-uystates_df %>% filter(!(NAME_1=="Rivera"& lat<6400000)) 
  
  theme_opts <-  list(  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    plot.background =  element_blank(),
    axis.line =    element_blank(),
    axis.text.x =  element_blank(),
    axis.text.y =  element_blank(),
    axis.ticks =   element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title =   element_text(
      size=16.4,
      colour="darkslategrey",
      hjust=0.25))   )
  
    ggplot() + geom_polygon(
    data = uystates_df,
    aes(
      x = long,
      y = lat,
      group = group,
      fill = n),
    color = "black",
    size = 0.25) +
    theme(aspect.ratio = 1) + 
    theme_opts
    
  } 

```



```{r,echo=F,fig.cap="Gráfico de barras: frecuencia absoluta de fallecidos por departamento."}


ggplot( 
  (datos %>% count(dep)  ),
  aes (reorder(abbreviate(dep,4),+n),n)) +
 geom_bar(stat="identity") +
 labs(
   x="Departamento",
   y="Frecuencia absoluta de fallecidos") +
 coord_flip() + 
 theme_minimal() + 
 theme(
   axis.title  =
     element_text(
       colour="grey30")) +  
 geom_hline( 
   yintercept = mean(  (datos %>% count(dep))$n   ),     
   cex=1.2,
   colour="#d8b960") 





```


La recta de color mostaza corresponde a la media  de fallecidos por deparatamento para todo el período designado.

El área metropolitana conformada por los departamentos de Montevideo, Maldonado, Canelones y San José superan la media de fallecidos en el país, lo que implica una clara concentracíon de los accidentes fatales en la zona sur del territorio nacional.

```{r}

# Censo 2011, fuente: INE.
censo<- c(73378,520187,84698,123203,57088,
          25050,67048,58815,164300,1319108,
          113124,54765,103493,68088,124878,
          108309,82595,90053,48134)

# Tasa de fallecidos cada 10.000 habitantes.
pob.dep<- cbind((datos %>% count(dep) %>% arrange(dep)),censo)%>% mutate(tasa=(n/censo)*10000)

```



```{r,echo=F,fig.cap="Grafico de mapas: tasa de fallecidos en accidentes de tránsito cada 10 mil habitantes por departamento."}


  mapeo(   cbind((datos %>% count(dep) %>% arrange(dep)),censo)%>% 
          mutate(n=(n/censo)*10000)    ) +
  labs(fill = "Tasa",
  x = NULL,
  y = NULL) +
  scale_fill_gradient2(
  low = "#d8b365",
    mid = "white",
    high = "#5ab4ac",
    midpoint = mean(pob.dep$tasa))

```


```{r,fig.cap="Gráfico de mapas: tasa de fallecidos en accidentes de tránsito cada 10 mil habitantes por departamento, faceteado por año."}


mapeo(n= (cbind((datos %>% count(a,dep) %>% arrange(a)), rep(censo,5)) %>% 
          mutate(n=(n/censo)*10000))  ) +
  labs(
    fill = "Tasa",
    x = NULL,
    y = NULL) +
  scale_fill_gradient2(
    low = "#d8b365",
    mid = "white",
    high = "#5ab4ac",
    midpoint = mean(
      (cbind((datos %>% count(a,dep) %>% arrange(a)), rep(censo,5)) %>%
                       mutate(n=(n/censo)*10000))$n )) +
  facet_wrap( ~ a)

```

El punto medio corresponde a 90 fallecidos. Este valor es elegido arbitrariamente con el fin de mejorar la visualizacion, debido a que la tanto la media como mediana poseen la mayoría de los departamentos a frecuencias absolutas muy disipersas.


### Fecha y hora

```{r,warning=FALSE,echo=F}

fecha<-datos %>% 
  separate(hora,c("hrs","min",sep=":")) %>% 
  separate(fecha,c("dia","mes")) %>%
  dplyr::select(1:5)

n.dia <-  weekdays(
  as.Date( 
    datos %>% separate(fecha, c("dia", "mes")) %>% 
      dplyr::select(a, mes, dia) %>% 
      unite(sep ="-") %>%
      unlist()))

f<-data.frame(fecha,n.dia)


```



```{r,fig.cap="Gráfico de serie de tiempo: frecuencia absoluta de fallecidos según año y mes."}




datos %>% separate(fecha,c("dia","mes")) %>% 
  mutate(a.mes=paste(a,mes,sep="-") ) %>%
  count(a.mes) %>% arrange(desc(a.mes)) %>%
     ggplot( 
       aes(a.mes,n,group=1) ) + 
     geom_point()  + 
  geom_line(
    stat="identity")+ 
  geom_smooth(
    method = "loess",
    colour=colores[2])+
     labs(
         x = "Año y mes",
         y = "Frecuencia absoluta") +
     theme_minimal() +
     theme(
         plot.title = element_text(
             size = 19,
             colour = "grey39",
             face = "bold",
             hjust = 0.4),
         axis.text.x =   element_text(
             colour = "grey27",angle=90,size=6)) +
  coord_cartesian( ylim = c(0,75)  )

#problemas con eje x:  scale_x_date(labels = date_format("%m-%Y")) error
```

 Se nota una leve tendencia en la frecuencia absoluta de fallecidos por mes, siendo decreciente hasta el año 2016 y luego retomando lentamente el crecimieto en 2017.
Existe un valor que si bien no llega a ser un dato atípico posee un gran desvío con repecto a la regresión lineal.


```{r,fig.cap="Diagrama térmico: frecuencia absoluta de fallecidos según día y hora del accidente."}

f %>% count(n.dia, hrs) %>%
  ggplot(aes(hrs, ordered(
    n.dia,
    levels = c( "lunes",  "martes",  "miércoles", 
                "jueves",  "viernes","sábado", "domingo" )))) +
  geom_tile(aes(fill = n)) + 
  scale_fill_gradient2(
    low = "white",
    high = "midnightblue",
    mid = "turquoise",
    midpoint = mean((f %>% count(n.dia, hrs))$n)) +
  labs(
    x = "Hora",
    y = "Día",
    fill="Fallecidos") +
  theme( 
    axis.title = element_text(
      size=13,
      colour="grey34",
      face="bold"),
    axis.text = element_text(
      size=10.4),
    panel.background = element_rect(
      colour="white"))

```

Los accidentes se concentran de 16:00 a 20:00 horas, aumentabdo paulativamente a medida se acercan los días correspondientes al fin de semana.


