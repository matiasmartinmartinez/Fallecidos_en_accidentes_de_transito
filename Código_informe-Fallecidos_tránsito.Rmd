---
title: "Siniestros de tránsito fatales en Uruguay, 2013-2017"
author: "Martínez Matías, Zang Bruno"
date: "2 de junio de 2018"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción:

El presente estudio surge de la curiosidad por conocer el comportamiento de los siniestros de tránsitos en Uruguay y posee como objetivo madre una profunda aplicación de los conocimientos adquiridos en la asignatura "Nuevas técnicas para el análisis de datos", marcando énfasis en un correcto análisis exploratorio y la generación de adecuadas visualizaciones de los datos.
Se analizara tanto los datos del fallecido como lo del suceso.




### Antecedentes
En su programa de Sistema de Información Nacional de Tránsito (SINATRÁN), donde se extrajo los datos, la Unidad Nacional de Seguridad Vial (UNASEV), genera un informe anual sobre la Siniestralidad Vial en Uruguay para el periodo dado desde 2009 a la actualidad.
Dicho informes se pueden encontrar a través del siguiente enlace:http://unasev.gub.uy/inicio/sinatran/informes_siniestralidad_vial_uruguay/

## Datos obtenidos

Los datos fueron obtenidos de la Unidad Nacional de Seguridad Víal (UNASEV), correspondientes al período comprendido entre 2013 y 2017. Originalmennte los datos correspondían al año 2017, sin embargo se identificó apropiada la utilización de una serie de tiempo por lo cual se mecharon bases desde el año 2013, esto provocó ciertos inconvenientes en cuanto a nombres de variables debido a la utilizacion de tildes o el aumento de variables para ciertos años pero finalmente fueron solucionados y concluimos en una base de datos apta y abarcativa.

Mediante su catálogo de datos abiertos se extraen las bases utilizadas, desde el siguiente url: http://unasev.gub.uy/inicio/sinatran/datos_abiertos/

### Población:
Corresponde a los 2527 fallecidos en accidentes de tránsito dentro del territorio uruguayo para el período antes señalado.

### Descripción de las variables:

Se poseen 15 variables identificadas de la siguiente manera:

- **a:** Año. 
- **fecha:** Dia y Mes. 
- **hora:** Hora.
- **dep:** Departamento.
- **jur:** Jurisdicción.
- **tipo.sin:** Tipo de Siniestro.
- **vehi:** Vehiculo.
- **rol:** Rol que cumplía.
- **edad:** Edad al fallecer.
- **Sexo:** Sexo de la persona.
- **f.dias:** Dia de supervivencia.
- **otro.vehi:** Otro vehiculo involucrado.
- **dir:** Lugar del accidente.
- **x:** Latitud.
- **y:** Longitud.

## Modelos y herramientas:

Es importarte recordar los objetivos del estudio, uno de ellos guía a la implementación de apropiadas visualizaciones. Para esto se utilizará el software estadístico R, con la puntual aplicación de paquete "tidyverse", que proporciona un conjunto de librerías óptimas para el análisis exploratorio de datos.
Con el fin de crear visualizaciónes oportunas se gestará su formación con la librería "ggplot2", perteneciente a tidyverse, la cual al trabajar mediante acumulación de capas (layers) posee una mayor flexibilidad y permite generar gráficos que representen correctamente los datos, sin generar interpretaciones confusas. Toma como referencia una metodología de visualización de datos llamada the Grammar of Graphics (Wilkinson, 2005), que consiste en especificar de manera independiente las componentes del gráfico como si fuesen bloques y luego combinarlas.


## Preguntas a responder

 - ¿Cuál es la distribución relativa por sexo y qué comportamiento posee la edad del fallecido en el período dado?

 - ¿Cuál es la densidad de fallecidos por departamento?
 
 - ¿Existe relación entre el vehículo del fallecido y su rol en el mismo?
 
 - ¿Cuál es la frecuencia relativa según el tipo de siniestro para cada año?
 
 - ¿Qué comportamiento posee la jurisdicción por si misma, y según el tipo de siniestro ocurrido?
 
 - ¿Hay relación entre el vehículo del fallecido y otro posible vehículo involucrado en el accidente?
 
 - ¿Cuál es la media de días de supervivencia luego del accidente?
 
 - ¿Qué fechas y horarios poseen mayor frecuencia acumulada de fallecidos?


## Hipótesis

- Se considera que el comportamiento de la edad estará dado por una fuerte densidad para edades cercanas a los 25, ya que se acompaña de poca experiencia al volante y pocas responsabilidades en comparación a mayores edades. Por ende, con respecto a la variable sexo, se preevé una mayor proporción de difuntos para las personas de sexo masculino.

- Debido a la concentración en zonas metropolitanas tanto en sectores productores, educativos, turísticos, ect; se provocán altos porcentajes de accidentes de tráficos y esto tendra como consecuencias que dichos departamentos indiquen las mayores proporciones de fallecidos en el país. 

- Por cuestiones de seguridad es de esperar frecuencias absolutas mayores para vehículos más débiles en su ensamblaje como motos, bicicletas, autos pequeños, etc. Dicho esto, se considera mayor mortalidad para conductores de los mismos y para los consiguentes vehículos la mortalidad estará dada principalmente en pasajeros, ya que su estructura protege mayormente al conductor.

- Los tipos de siniestros que mayoritariamente se llevan vidas serán colisión entre vehículos e impacto con obstáculos. Esta hipótesis surge en la brusquedad identificada para dichos accidentes.

- Se prevé mayor proporción de accidentes fatales en rutas nacionales, esto en base principalmente a la práctica de altas velocidades. Tanto despistes como colisiones tendrán mayor propoción de fallecidos en rutas no departamentales, sin embargo he de excluirse atropello de peatones de dicha jurisdicción debido a su nula circulación en las mismas.

- Colisiones entre un vehiculo de gran magnitud y otro de menor provocaría que el de menor quede expuesto a graves consecuencias, esto genera la hipotesis de una fuerte relacion en fallecimientos en vehiculos como: motos, bicicletas, inclusive peatones, ect; al impactar con autos, camionetas, ómnibus,camiones,ect.

- Consiguiente a anteriores menciones, tales impactos generían una muerte instantánea o de poca supervivencia para el individuo. Si valoramos posibles traslados desde carretera o largas distancias a un centro de atención médica de calidad (los cuales en mayor grado se encuentran en la capital nacional) las probabilidades de salir con vida de dicho accidente se reducen drasticamente.

- En meses de vacaciones se provocarían mayores accidentes de tráfico producto de congregaciones y movimientos en general. Respecto al día y hora se considera altas frecuencias absolutas para fines de semana en horarios nocturnos.


## 

```{r,echo=F,warning=FALSE,error=FALSE}

ipack <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
}
  x<-c("tidyverse", "ggmosaic", "plotly", "ggmap", "raster","rgdal")
ipack(x)

library(tidyverse)
library(knitr)
library(ggmosaic)
library(plotly)
library(ggmap)
library(raster)


load("base_datos___fallecidos_transito_uruguay_2013-2017.RData")
```
# Análisis Exploratorio de Datos

```{r}

dim(datos)
str(datos)
```




### Fallecidos por año
```{r,warning=FALSE,echo=F}


ggplotly(datos %>% count(a)  %>% ggplot(aes(reorder(a,-n),n)) + geom_bar(stat="identity",aes(fill=a),show.legend = F) + labs(x="Año", y=" Frecuencia relativa de fallecidos",title="Gráfico de barras: frecuencia relativa fallecidos por año") + theme(plot.title = element_text(size=16,colour="grey16")))
```




### Sexo
```{r,echo=F}


ggplotly(datos %>% count(a,sexo) %>% ggplot() + geom_mosaic(aes(weight=n,x=product(a),fill=sexo))+ labs(x="Año",y="Proporción según sexo",title="Gráfico de Mosaico: frecuencia relativa fallecidos por sexo") + theme(plot.title = element_text(size=14.4,colour = "darkslategrey")))

```




### Edad
```{r,echo=F}
datos %>% ggplot(aes(edad))+ geom_density(aes(fill=a),size=0.74,colour="grey10",show.legend = F) + labs(x="Edad",y="Densidad", title="Gráfico de densidad: edad del fallecido") + facet_wrap(~a) + theme_gray() + theme(plot.title = element_text(size=16,face="bold",hjust=0.4,colour="grey20"))




ggplotly(datos %>% ggplot(aes(sexo,edad)) + stat_boxplot(aes(fill=sexo),show.legend = F) + labs(x="Sexo",y="Edad en años",title="Diagrama de caja: edad según sexo") + theme(plot.title=element_text(size=16,colour="grey19"))+ scale_fill_manual(values=c("yellow3","springgreen3"))) 



datos %>% ggplot(aes(edad))+ geom_density(aes(fill=rol),alpha=0.6,show.legend = T) + labs(x="Edad",y="Densidad", title="Gráfico de densidad: proporción de edad según rol")  + theme_gray() +guides(fill = guide_legend(title = "Rol")) + theme(legend.position = "bottom",plot.title = (element_text(size=16,hjust=0.33,colour="darkslategray")))
```





### Vehículo
```{r,echo=F}


datos %>% count(vehi,a) %>% mutate(prop=n/sum(n)) %>% filter(n>=0)  %>% ggplot(aes(reorder(abbreviate(vehi,6),-prop),prop)) + geom_bar(stat="identity") + labs(x="Vehículo",y="Proporción",title= "Gráfico de barras: proporción de vehículo por año") + theme(plot.title = element_text(size=17,hjust=0.35,colour="lightpink4"))
```





### Relación vehículo
```{r,echo=F,warning=FALSE}


ggplotly(datos %>% count(vehi,rol) %>% filter(n>=5) %>% ggplot() + geom_mosaic(aes(weight=n,x=product(abbreviate(vehi,4)),fill=abbreviate(rol,1)))+labs(x="Vehículo",title="Gráfico de mosaico: rol según vehículo") + guides(fill = guide_legend(title = "Rol")) + theme_minimal() + theme(plot.title = element_text(size=18,colour="aquamarine4"),axis.text.x = element_text(angle=40,size=9)) + scale_fill_brewer(palette="Dark2")) %>% layout(annotations= list(text="Únicamente fueron tomadas las relaciones con frecuencia absoluta mayor o igual a 5 fallecidos",x = 1, y = -0.201,showarrow = F, xref='paper', yref='paper', xanchor='right',   font=list(size=11)))





 ggplotly(datos %>% count(vehi,otro.vehi) %>% filter(n>=50) %>% ggplot() + geom_mosaic(aes(weight=n,x=product(vehi),fill=otro.vehi))+ labs(x="Vehículo", y="Proporción",title="Gráfico de mosaico: relación entre los vehículos involucrados") + guides(fill = guide_legend(title = "Otro vehículo")) + scale_fill_manual(values=c("darkseagreen4","tan2","indianred","khaki3","thistle4","lightsteelblue")) + theme(plot.title = element_text(colour="gray37",size=16)))
```

Únicamente incluye las relaciones con frecuencia absoluta mayores o iguales a 50 fallecidos.






### Departamento por año
```{r,echo=F}
 ggplot(datos %>% count(dep) ,aes(reorder(abbreviate(dep,4),+n),n)) + geom_bar(stat="identity") + labs(x="Departamento",y="Frecuencia acumulada",title="Gráfico de barras: frecuencia acumulada por departamento") + coord_flip() + theme_minimal() + theme(plot.title = element_text(hjust = 0.4,colour="palevioletred4",size=15,face="bold")) +  geom_hline(yintercept = mean((datos %>% count(dep))$n) ,cex=1.2,colour="coral3") 
```





### Jurisdicción
```{r,echo=F}




datos %>% count(jur,a) %>% mutate(prop=n/sum(n)) %>% ggplot() + geom_bar(stat="identity",aes(a,prop,fill=jur), position=position_dodge(),show.legend = T) + labs(x="Jurisdicción",y="Proporción",title="Gráfica de barras: proporción de la jurisdicción") + scale_fill_manual(values=c("skyblue3","tan2")) + theme(plot.title = element_text(size=17.5,colour="gray29",hjust=0.4),legend.position = "bottom")  + guides(fill = guide_legend(title = "Jurisdicción"))





 datos %>% count(involucrado,jur) %>% ggplot() + geom_mosaic(aes(weight=n,x=product(jur),fill=involucrado)) + labs(x="Jurisdicción",y="Proporción involucrado",title="Gráfico de mosaico: otro vehículo involucrado según jurisdicción") + theme(plot.title = element_text(size=15,face="italic",colour = "grey20")) + scale_fill_manual(values=c("yellow3","mediumpurple"))


 
 
 

datos %>% count(tipo.sin,jur) %>% filter(n>=20) %>% ggplot() + geom_mosaic(aes(weight=n,x=product(abbreviate(tipo.sin,5)),fill=jur)) + theme(legend.position = "bottom",plot.title = element_text(hjust=0.4,size=17,colour="gray32")) + labs(x="Tipo de siniestro",y="Proporción jurisdicción", title="Gráfico de mosaicos: jurisdicción según tipo de siniestro",fill="Jurisdicción", caption="Solamente se incluyen los tipos de accidente con una frecuencia absoluta mayor o igual a 20.") + scale_fill_manual(values=c("cornflowerblue","seagreen3"))
```




### Días de supervivencia
```{r,echo=F,warning=FALSE}
ggplotly(datos %>% ggplot() + stat_boxplot(aes(rol,edad,fill=sexo),show.legend = F)+ facet_wrap(~sexo) + labs(x="Rol",y="Edad",title="Diagrama de caja: edad según rol, faceteado por sexo") + theme(plot.title = element_text(size=17,face="italic")))




ggplotly(datos %>% count(f.dias)%>% mutate(n=n/sum(n)) %>% ggplot() + geom_bar(aes(f.dias,n),stat="identity") +labs(x= "Días de supervivencia luego del accidente" , y= "Proporción" , title="Gráfico de barras: proporción de días de supervivencia") + theme(plot.title = element_text(hjust = 0.4,size=16,colour="gray27")))





datos %>% filter(f.dias==0) %>% count(tipo.sin)%>% mutate(n=n/sum(n)) %>% ggplot() + geom_bar(aes(reorder(abbreviate(tipo.sin,6),-n),n),stat="identity") +labs(x= "Tipo de Siniestro" , y= "Proporción" , title="Gráfico de barras: proporción de muerte súbita según tipo de siniestro", caption="Muerte súbita hace alución a la persona que falleció en el acto o en menos de 24 horas luego de ocurrido el accidente.") + theme(plot.title = element_text(size = 15,colour="grey20"))
```



### Fecha y hora

```{r,warning=FALSE,echo=F}
fecha<-datos %>% separate(hora,c("hrs","min",sep=":")) %>%  separate(fecha,c("dia","mes")) %>% dplyr::select(1:5)

n.dia<-weekdays(as.Date(datos %>% separate(fecha,c("dia","mes")) %>% dplyr::select(a,mes,dia) %>% unite(sep="-") %>% unlist()))

f<-data.frame(fecha,n.dia)


f %>% count(mes) %>% arrange(desc(n)) %>% ggplot(aes(mes,n)) + geom_bar(aes(fill=2),stat="identity",show.legend = F) + labs(x="Mes", y="Frecuencia absoluta" ,title="Gráfico de barras: frecuencia absoluta por mes") + theme_minimal() + theme(plot.title = element_text(size=17,colour="grey30",face="bold",hjust=0.4))


f %>% count(n.dia, hrs) %>% ggplot( aes(hrs,ordered(n.dia, levels=c("lunes","martes","miércoles","jueves","viernes","sábado","domingo" )))) + geom_tile(aes(fill=n)) + scale_fill_gradient2(low = "red2", high = "red2", mid = "yellow") + labs(x="Hora",y="Día",title="Diagrama térmico: día según hora ") + theme(plot.title = element_text(size=17,colour="grey30",face="bold",hjust=0.4))
```





### Dirección
```{r,warning=FALSE,echo=FALSE}
uruguay <- getData("GADM", country = "UY", level = 0)
uruguay_states <- getData("GADM", country = "UY", level = 1)
uystates_UTM <-spTransform(uruguay_states, CRS("+init=EPSG:5383"))
NAME_1 <- uystates_UTM@data$NAME_1




mapeo<-function(n){
df <- data.frame(NAME_1,n)
uystates_UTM@data$id <- rownames(uystates_UTM@data)
uystates_UTM@data <- plyr::join(uystates_UTM@data, df, by="NAME_1")
uystates_df <- fortify(uystates_UTM)
uystates_df <- plyr::join(uystates_df,uystates_UTM@data, by="id")
uystates_df <-uystates_df %>% filter(!(NAME_1=="Rivera"& lat<6400000)) 
theme_opts <- list(theme(panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
panel.background = element_blank(),
plot.background = element_blank(),
axis.line = element_blank(),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
plot.title = element_text(size=16.4,colour="darkslategrey",hjust=0.25)))
ggplot() + geom_polygon(data = uystates_df, aes(x = long, y = lat, group = group, fill =n), color = "black", size = 0.25)+ theme(aspect.ratio = 1)+ theme_opts} 




mapeo(n=datos%>% count(dep))+ labs(fill = "Cantidad",x=NULL,y=NULL,title="Gráfico de mapas: cantidad de fallecidos por departamento") + theme_opts + scale_fill_gradient2(low = "grey2", mid = "midnightblue",  high = "white")


mapeo(n=datos%>% count(dep,a))+labs(fill = "Cantidad",x=NULL,y=NULL,title="Gráfico de mapas: cantidad de fallecidos en departamento por año") + theme_opts + scale_fill_gradient2(low = "red", mid = "white",  high = "blue", midpoint =75) +facet_wrap(~a) 

#df <- data.frame(NAME_1,n=datos%>% count(dep,a))
#df
#error: no me creó el data.frame adecuado, por eso Montevideo no se ve en colores altos para todos los años, probar ordenando por año antes de crear el data.frame
```
El punto medio corresponde a 75 fallecidos. Este valor es elegido arbitrariamente con el fin de mejorar la visualizacion, debido a que la tanto la media como mediana poseen la mayoría de los departamentos a frecuencias absolutas muy disipersas.
